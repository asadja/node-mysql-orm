<!DOCTYPE html>
<!-- Generated by litjs - https://github.com/apres/lit.js
     Part of the Apres suite - http://apres.github.com/ -->
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <title>mysql-orm: index.js</title>
  <link href='css/lit-callouts.css' rel='stylesheet' type='text/css'>
  <link href='css/apres.css' rel='stylesheet' type='text/css'>
</head>
<body>
  <div class="lit">
<section>
<div class="lit-comment">
<h1>mysql-orm: index.js</h1>
</div>
<code class="lit-code">
<span class="string">'use strict'</span>;
<span class="comment">/*
 * MySQL object-relational mapping
 * ===============================
 *
 * (C) 2014 Mark K Cowan &lt;mark@battlesnake.co.uk>
 *
 * https://github.com/battlesnake/node-mysql-orm
 *
 * Released under GNU General Public License, Version 2
 *
 */</span>

<span class="keyword">var</span> mysql = require(<span class="string">'mysql'</span>);
<span class="keyword">var</span> async = require(<span class="string">'async'</span>);
<span class="keyword">var</span> _ = require(<span class="string">'underscore'</span>);

<span class="keyword">var</span> utils = require(<span class="string">'./utils'</span>);
</code>
</section>
<section>
<div class="lit-comment">
<h1>mysql-orm</h1>

<p>MySQL wrapper for nodejs with focus on foreign keys, rapid development, and<br />easy deployment.</p>

<h2>exports.create</h2>

<p>Use this to create an ORM instance.  The parameters are passed through to the<br />ORM constructor.  See the documentation for the ORM constructor, below.</p>

<p>var mysqlOrm = require('mysql-orm');<br />var orm = mysqlOrm.create(schema, data, options, function (err, orm) {<br />if (err) throw err;<br />...<br />});</p>
</div>
<code class="lit-code">
module.exports.create = <span class="function"><span class="keyword">function</span> <span class="params">(schema, defaultdata, options, onready)</span> {</span>
  <span class="keyword">return</span> <span class="keyword">new</span> ORM(schema, defaultdata, options, onready);
};
</code>
</section>
<section>
<div class="lit-comment">
<h2>names</h2>

<p>Returns an array of names of properties of the object excluding names that<br />begin with a '
</body>
</html>
 symbol.</p>
</div>
<code class="lit-code">
module.exports.names = <span class="function"><span class="keyword">function</span> <span class="params">(obj)</span> {</span>
  <span class="keyword">return</span> utils.names(obj);
};
</code>
</section>
<section>
<div class="lit-comment">
<h2>ORM constructor</h2>

<ul>
<li>schema - Defines the structure of the database and the relations.
This is described below.</li>
<li>defaultdata - Initial data to put in database if we (re-)create it.
This is described below.</li>
<li>options - ORM configuration</li>
<li>database - Name of the database</li>
<li>mysql - MySQL connection parameters (felixge/node-mysql)</li>
<li>debug - Slows the logger</li>
<li>logLevel - Set the logging verbosity. <strong>MUST BE &gt;= 1</strong></li>
<li>Errors only (throws them after logging)</li>
<li>Warnings and level 1</li>
<li>Debugging info and level 2</li>
<li>recreateDatabase - Drop the database and recreate it <strong>DANGER</strong></li>
<li>recreateTables - Drop tables and recreate them <strong>DANGER</strong></li>
<li>skipChecks - Don't check existence of database and tables (causes
recreate* params to be ignored), don't initialise database, onready is</li>
</ul>

<h3>Dataset definition</h3>

<p>defaultdata = {<br />table-name: [<br />{ field-name: field-value, field-name: field-value, ... }<br />],<br />table-name: [<br />...<br />],<br />...<br />}</p>

<p>field-value = &lt;value&gt; | reference-criteria</p>

<h3>Example dataset using reference criteria</h3>

<p>var defaultdata = {<br />users: [<br />{<br />name: 'Mark',<br />age: 25,<br />country: { id: 370 },<br />role: { name: 'admin' }<br />}<br />],<br />countries: [<br />{ id: 44, name: 'United Kingdom' },<br />{ id: 370, name: 'Lithuania' },<br />{ id: 372: name: 'Estonia' }<br />]<br />};</p>

<h3>Schema definition</h3>

<p>schema = {<br />[ $types: type-aliases, ]<br />table-name: table-definition,<br />table-name: table-definition,<br />...<br />}</p>

<h4>Type aliases</h4>

<p>type-aliases = [<br />alias-name: basic-type,<br />alias-name: basic-type,<br />...<br />]</p>

<h4>Table definitions</h4>

<p>// &lt;id: '::id'&gt; is automatically added to all tables for now<br />table-definition = {<br />[ $primary: field-list, ]    // Not implemented yet<br />[ $sort: field-list, ]<br />field: field-definition,<br />field: field-definition,<br />...<br />}</p>

<h4>Field definitions</h4>

<p>field-definition = 'type-name[,index][,unique][,nullable][,cascade]'</p>

<p>field-definition =  {<br />type: type-name,<br />[ index: boolean ],<br />[ unique: boolean ],<br />[ nullable: boolean ],<br />[ default: value ],<br />[ onDelete: reference-option ],<br />[ onUpdate: reference-option ],<br />[ references: field-definition | table-name ]    // Not tested yet<br />}</p>

<h4>Types</h4>

<p>type-name = alias-name | basic-type</p>

<p>basic-type = database-type | reference-type</p>

<p>database-type = 'VARCHAR(16)', 'TIMESTAMP', 'BIT', 'INTEGER', etc</p>

<p>reference-type = ':table-name'</p>

<h4>Field list</h4>

<p>field-list = 'field-name' | ['field-name', 'field-name', ...]</p>

<h4>Reference option</h4>

<p>reference-option = 'set null' | 'cascade' | 'ignore'</p>
</div>
<code class="lit-code">
<span class="function"><span class="keyword">function</span> <span class="title">ORM</span><span class="params">(schema, defaultdata, options, onready)</span> {</span>
  <span class="keyword">var</span> self = <span class="keyword">this</span>;
  <span class="keyword">this</span>.debug = options.debug || process.env.DEBUG_MYSQL_ORM;
  <span class="keyword">if</span> (!schema || !options || (!options.skipChecks &amp;&amp; !onready)) {
    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Required parameter missing'</span>);
  }
  <span class="keyword">if</span> (_(options).has(<span class="string">'logLevel'</span>)) {
    <span class="keyword">this</span>.logLevel = options.logLevel;
    <span class="keyword">if</span> (process.env.DEBUG_MYSQL_ORM) {
      <span class="keyword">this</span>.logLevel = <span class="number">9</span>;
    }
  }
  <span class="keyword">if</span> (!options.database) {
    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Compulsory option (lol) `database` not specified'</span>);
  }
  <span class="keyword">if</span> (!options.mysql) {
    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Compulsory option (lol) `mysql` not specified'</span>);
  }
  <span class="keyword">this</span>.database = options.database;
  <span class="keyword">this</span>.schema = JSON.parse(JSON.stringify(schema));
  <span class="keyword">this</span>.types = schema.$types;
  Internal.initialise_schema(<span class="keyword">this</span>);
  Internal.parse_schema(<span class="keyword">this</span>);
  <span class="keyword">var</span> createConnectionPool = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    options.mysql.database = options.database;
    self.connection = mysql.createPool(options.mysql);
    self.query = self.loggedQuery(self.connection);
  };
  <span class="comment">/* No checks - connect to the DB and return synchronously */</span>
  <span class="keyword">if</span> (options.skipChecks) {
    createConnectionPool();
    self.ready = <span class="literal">true</span>;
    <span class="keyword">if</span> (_(onready).isFunction()) {
      onready(<span class="literal">null</span>, self);
    }
    <span class="keyword">return</span>;
  }
  <span class="comment">/* Statup checks */</span>
  async.series([
      <span class="comment">/* Create database */</span>
      <span class="function"><span class="keyword">function</span> <span class="params">(callback)</span> {</span>
        self.connection = mysql.createConnection(options.mysql);
        self.query = self.loggedQuery(self.connection);
        callback();
      },
      async.apply(Internal.create_database, self, options.recreateDatabase),
      <span class="function"><span class="keyword">function</span> <span class="params">(callback)</span> {</span>
        self.connection.end(callback);
      },
      <span class="comment">/* Create connection pool */</span>
      <span class="function"><span class="keyword">function</span> <span class="params">(callback)</span> {</span>
        createConnectionPool();
        callback(<span class="literal">null</span>);
      },
      <span class="comment">/* Create tables and initialize data */</span>
      async.apply(Internal.create_tables, self, options.recreateTables),
      <span class="function"><span class="keyword">function</span> <span class="params">(callback)</span> {</span>
        <span class="keyword">if</span> (defaultdata &amp;&amp; (options.recreateTables || options.recreateDatabase)) {
          <span class="keyword">return</span> self.saveMultipleTables(defaultdata, callback);
        }
        callback(<span class="literal">null</span>);
      }
    ],
    <span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
      self.ready = <span class="literal">true</span>;
      <span class="keyword">if</span> (_(onready).isFunction()) {
        onready(<span class="literal">null</span>, self);
      }
    });
}

ORM.prototype = {};
ORM.prototype.constructor = ORM;

_(ORM.prototype).extend(require(<span class="string">'./logging'</span>));
_(ORM.prototype).extend(require(<span class="string">'./logging-query'</span>));
_(ORM.prototype).extend(require(<span class="string">'./transaction'</span>));
_(ORM.prototype).extend(require(<span class="string">'./foreign-keys'</span>));
_(ORM.prototype).extend(require(<span class="string">'./save'</span>));
_(ORM.prototype).extend(require(<span class="string">'./load'</span>));
_(ORM.prototype).extend(require(<span class="string">'./delete'</span>));

<span class="keyword">var</span> Internal = {};
_(Internal).extend(require(<span class="string">'./autogen'</span>));
_(Internal).extend(require(<span class="string">'./initialise-schema'</span>));
_(Internal).extend(require(<span class="string">'./parse-schema'</span>));
</code>
</section>
</div>

</body>
</html>
