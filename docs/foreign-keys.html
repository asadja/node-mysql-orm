<!DOCTYPE html>
<!-- Generated by litjs - https://github.com/apres/lit.js
     Part of the Apres suite - http://apres.github.com/ -->
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <title>mysql-orm: foreign-keys.js</title>
  <link href='css/lit-callouts.css' rel='stylesheet' type='text/css'>
  <link href='css/apres.css' rel='stylesheet' type='text/css'>
</head>
<body>
  <div class="lit">
<section>
<div class="lit-comment">
<h1>mysql-orm: foreign-keys.js</h1>
</div>
<code class="lit-code">
<span class="string">'use strict'</span>;
<span class="comment">/*
 * MySQL object-relational mapping
 * ===============================
 *
 * (C) 2014 Mark K Cowan &lt;mark@battlesnake.co.uk>
 *
 * https://github.com/battlesnake/node-mysql-orm
 *
 * Released under GNU General Public License, Version 2
 *
 */</span>

<span class="keyword">var</span> mysql = require(<span class="string">'mysql'</span>);
<span class="keyword">var</span> _ = require(<span class="string">'underscore'</span>);
<span class="keyword">var</span> async = require(<span class="string">'async'</span>);

<span class="keyword">var</span> utils = require(<span class="string">'./utils'</span>);
<span class="keyword">var</span> sql = require(<span class="string">'./sql'</span>);

<span class="keyword">var</span> names = utils.names;
<span class="keyword">var</span> parse_args = utils.parse_args;

<span class="keyword">var</span> ORM = { prototype: {} };
module.exports = ORM.prototype;
</code>
</section>
<section>
<div class="lit-comment">
<h1>foreign-keys</h1>

<p>Foreign key support</p>

<p>The options query parameter is a function (format, params, callback),<br />such as the mysql connection.query method.  This allows intercepting of<br />queries (e.g. for logging) and transactional operations even when the ORM<br />is using a connection pool.</p>

<h2>listForeignKeys(table)</h2>

<p>Returns an array of names of fields in the table which have a foreign key<br />constraint.</p>

<h3>Example</h3>

<p>var names = listForeignKeys(schema.users);</p>
</div>
<code class="lit-code">
ORM.prototype.listForeignKeys = <span class="function"><span class="keyword">function</span> <span class="params">(table)</span> {</span>
  <span class="keyword">if</span> (_(table).isString()) {
    table = <span class="keyword">this</span>.schema[table];
  }
  <span class="keyword">return</span> names(table).filter(<span class="function"><span class="keyword">function</span> <span class="params">(col)</span> {</span> <span class="keyword">return</span> !!table[col].references; });
};
</code>
</section>
<section>
<div class="lit-comment">
<h2>lookupForeignId([query] field criteria [options] callback)</h2>

<p>Looks up the id of the parent record, identified by search criteria. Returns<br />an error if no or if multiple parent records are found.  In such a case, the<br />second callback paremeter is zero or two for no or multiple records found.</p>

<h3>Example</h3>

<p>lookupForeignKey(schema.users.country, { name: 'Estonia' },<br />function (err, value) { ... });</p>
</div>
<code class="lit-code">
ORM.prototype.lookupForeignId = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">var</span> args = parse_args(<span class="keyword">this</span>, arguments, <span class="literal">true</span>);
  <span class="keyword">var</span> query = args.query;
  <span class="keyword">var</span> field = args.field;
  <span class="keyword">var</span> criteria = args.data;
  <span class="keyword">var</span> options = args.options;
  <span class="keyword">var</span> callback = args.callback;
  <span class="keyword">var</span> self = <span class="keyword">this</span>;
  <span class="keyword">var</span> foreign = field.references;
  async.parallel([
      async.apply(sql.select, <span class="keyword">this</span>, [foreign.$name]),
      async.apply(sql.from, <span class="keyword">this</span>, foreign.$table),
      async.apply(sql.where, <span class="keyword">this</span>, query, foreign.$table, criteria),
      async.apply(sql.limit, <span class="keyword">this</span>, { count: <span class="number">2</span> })
    ],
    <span class="function"><span class="keyword">function</span> <span class="params">(err, sqlParts)</span> {</span>
      query(_(sqlParts).compact().join(<span class="string">'\n'</span>), <span class="literal">null</span>, <span class="function"><span class="keyword">function</span> <span class="params">(err, rows)</span> {</span>
        <span class="keyword">if</span> (err) {
          self.warn(<span class="string">'Error occurred while looking up foreign id'</span>);
          <span class="keyword">return</span> callback(err);
        }
        <span class="keyword">if</span> (rows.length !== <span class="number">1</span>) {
          <span class="keyword">return</span> callback(<span class="keyword">new</span> Error(self.warn(
                (rows.length > <span class="number">1</span> ? <span class="string">'Multiple'</span> : <span class="string">'No'</span>) +
                <span class="string">' foreign ids found'</span>)),
                rows.length);
        }
        callback(<span class="literal">null</span>, rows[<span class="number">0</span>][foreign.$name]);
      });
    });
};
</code>
</section>
<section>
<div class="lit-comment">
<h2>lookupForeignIds([query] table row [options] callback)</h2>

<p>Looks up all foreign key values for a row</p>

<p>Any foreign-key fields in row which contain an object are assumed to be<br />search criteria.  lookupForeignId is used to fill in their corresponding id<br />values.  Those values of row are replaced with the id values, then the same<br />(modified) row object is passed to the callback.</p>

<h3>Example</h3>

<p>lookupForeignIds(schema.users,<br />{<br />name: 'mark',<br />country: { name: 'Estonia' },<br />role: { name: 'admin' }<br />},<br />function (err, value) { ... });</p>

<p>// value.country = 372, value.role = &lt;some id value&gt;</p>
</div>
<code class="lit-code">
ORM.prototype.lookupForeignIds = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">var</span> args = parse_args(<span class="keyword">this</span>, arguments);
  <span class="keyword">var</span> query = args.query;
  <span class="keyword">var</span> table = args.table;
  <span class="keyword">var</span> row = args.data;
  <span class="keyword">var</span> callback = args.callback;
  <span class="keyword">var</span> options = args.options;
  <span class="keyword">var</span> self = <span class="keyword">this</span>;
  <span class="keyword">var</span> cols = options.cols || <span class="keyword">this</span>.listForeignKeys(table);
  async.each(cols,
    <span class="function"><span class="keyword">function</span> <span class="params">(col, callback)</span> {</span>
      <span class="keyword">var</span> field = table[col];
      <span class="keyword">if</span> (!field) {
        <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Field "'</span> + col + <span class="string">'" not found in table "'</span> +
          table.$name + <span class="string">'"'</span>);
      }
      <span class="keyword">var</span> value = row[col];
      <span class="keyword">if</span> (!_(value).isObject()) {
        <span class="keyword">return</span> callback(<span class="literal">null</span>);
      }
      self.lookupForeignId(query, field, value, <span class="function"><span class="keyword">function</span> <span class="params">(err, res)</span> {</span>
        <span class="keyword">if</span> (err) {
          <span class="keyword">return</span> callback(err);
        }
        row[col] = res;
        callback(<span class="literal">null</span>);
      });
    },
    <span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
      callback(err, row);
    });
};
</code>
</section>
<section>
<div class="lit-comment">
<h2>lookupForeignValue([query] field id [options] callback)</h2>

<p>Get the data corresponding to a given ID value in a foreign key ralationship</p>
</div>
<code class="lit-code">
ORM.prototype.lookupForeignValue = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">var</span> args = parse_args(<span class="keyword">this</span>, arguments, <span class="literal">true</span>);
  <span class="keyword">var</span> query = args.query;
  <span class="keyword">var</span> field = args.field;
  <span class="keyword">var</span> id = args.data;
  <span class="keyword">var</span> callback = args.callback;
  <span class="keyword">var</span> options = args.options;
  <span class="keyword">var</span> self = <span class="keyword">this</span>;
  <span class="keyword">var</span> foreign = field.references;
  <span class="keyword">var</span> criteria = _.object([foreign.$name], [id]);
  <span class="keyword">this</span>.load(query, foreign.$table, criteria, options, <span class="function"><span class="keyword">function</span> <span class="params">(err, res)</span> {</span>
    <span class="keyword">if</span> (err) {
      self.warn(<span class="string">'Error occurred while looking up foreign row'</span>);
      <span class="keyword">return</span> callback(err);
    }
    callback(<span class="literal">null</span>, res);
  });
};
</code>
</section>
<section>
<div class="lit-comment">
<h2>lookupForeignValues([query] table row [options] callback)</h2>

<p>Uses lookupForeignValue to get data for fields which have foreign key<br />relationships</p>
</div>
<code class="lit-code">
ORM.prototype.lookupForeignValues = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">var</span> args = parse_args(<span class="keyword">this</span>, arguments);
  <span class="keyword">var</span> query = args.query;
  <span class="keyword">var</span> table = args.table;
  <span class="keyword">var</span> row = args.data;
  <span class="keyword">var</span> callback = args.callback;
  <span class="keyword">var</span> options = args.options;
  <span class="keyword">var</span> cols = options.cols || <span class="keyword">this</span>.listForeignKeys(table);
  <span class="keyword">var</span> self = <span class="keyword">this</span>;
  async.each(cols,
    <span class="function"><span class="keyword">function</span> <span class="params">(col, callback)</span> {</span>
      <span class="keyword">var</span> field = table[col], id = row[col], foreign = field.references;
      <span class="keyword">if</span> (_(id).isNull() || _(id).isObject()) {
        <span class="keyword">return</span> callback(<span class="literal">null</span>);
      }
      self.lookupForeignValue(query, field, id, options, <span class="function"><span class="keyword">function</span> <span class="params">(err, res)</span> {</span>
        <span class="keyword">if</span> (err) {
          <span class="keyword">return</span> callback(err);
        }
        row[col] = res;
        callback(<span class="literal">null</span>);
      });
    },
    <span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
      callback(err, row);
    });
};
</code>
</section>
</div>

</body>
</html>
