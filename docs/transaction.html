<!DOCTYPE html>
<!-- Generated by litjs - https://github.com/apres/lit.js
     Part of the Apres suite - http://apres.github.com/ -->
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <title>mysql-orm: transaction.js</title>
  <link href='css/lit-callouts.css' rel='stylesheet' type='text/css'>
  <link href='css/apres.css' rel='stylesheet' type='text/css'>
</head>
<body>
  <div class="lit">
<section>
<div class="lit-comment">
<h1>mysql-orm: transaction.js</h1>
</div>
<code class="lit-code">
<span class="string">'use strict'</span>;

<span class="comment">/*
 * MySQL object-relational mapping
 * ===============================
 *
 * (C) 2014 Mark K Cowan &lt;mark@battlesnake.co.uk>
 *
 * https://github.com/battlesnake/node-mysql-orm
 *
 * Released under GNU General Public License, Version 2
 *
 */</span>

<span class="keyword">var</span> cli = require(<span class="string">'cli-color'</span>);

<span class="keyword">var</span> ORM = { prototype: {} };
module.exports = ORM.prototype;
</code>
</section>
<section>
<div class="lit-comment">
<h2>beginTransaction(callback)</h2>

<p>Acquires a connection [from the pool if pooled] and begins a transaction</p>

<p>The connection is released back to the pool after rollback or after a<br />successful commit [if pooled].</p>

<p>callback = function (err, { connection, query, commit, rollback })</p>

<ul>
<li>connection: database connection</li>
<li>query: connection.query (tapped for logging)</li>
<li>commit: function (callback(err))</li>
<li>rollback function (callback(err))</li>
</ul>
</div>
<code class="lit-code">
ORM.prototype.beginTransaction = <span class="function"><span class="keyword">function</span> <span class="params">(callback)</span> {</span>
  <span class="keyword">var</span> self = <span class="keyword">this</span>;
  <span class="keyword">var</span> pooled = <span class="keyword">this</span>.connection.getConnection;
  <span class="keyword">if</span> (pooled) {
    <span class="keyword">this</span>.connection.getConnection(gotConnection);
  }
  <span class="keyword">else</span> {
    gotConnection(<span class="keyword">this</span>.conncetion);
  }
  <span class="function"><span class="keyword">function</span> <span class="title">gotConnection</span><span class="params">(err, connection)</span> {</span>
    <span class="keyword">if</span> (err) {
      <span class="keyword">return</span> callback(err);
    }
    connection.beginTransaction(<span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
      <span class="keyword">if</span> (err) {
        <span class="keyword">return</span> callback(err);
      }
      <span class="keyword">var</span> transaction = {};
      transaction.connection = connection;
      transaction.query = self.loggedQuery(connection);
      transaction.released = <span class="literal">false</span>;
      transaction.release = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        <span class="keyword">if</span> (!pooled) {
          <span class="keyword">return</span> self.info(<span class="string">'Attempted to release a connection that isn\'t pooled'</span>);
        }
        <span class="keyword">if</span> (transaction.released) {
          <span class="keyword">return</span> self.warn(<span class="string">'Attempted to release an already released connection'</span>);
        }
        connection.release();
        transaction.released = <span class="literal">true</span>;
      };
      transaction.commit = <span class="function"><span class="keyword">function</span> <span class="params">(callback)</span> {</span>
        self.info(transaction.query._msg(cli.cyan(<span class="string">'Commit transaction'</span>)));
        connection.commit(<span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
          <span class="keyword">if</span> (err) {
            self.warn(transaction.query._msg(<span class="string">'Commit failed: '</span> + err));
            <span class="keyword">return</span> callback(err);
          }
          transaction.release();
          callback(<span class="literal">null</span>);
        });
      };
      transaction.rollback = <span class="function"><span class="keyword">function</span> <span class="params">(callback)</span> {</span>
        self.info(transaction.query._msg(cli.cyan(<span class="string">'Rollback transaction'</span>)));
        connection.rollback(<span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
          transaction.release();
          <span class="keyword">if</span> (err) {
            self.warn(transaction.query._msg(<span class="string">'Rollback failed: '</span> + err));
            <span class="keyword">return</span> callback(err);
          }
          callback(<span class="literal">null</span>);
        });
      };
      self.info(transaction.query._msg(cli.cyan(<span class="string">'Begin transaction'</span>)));
      callback(<span class="literal">null</span>, transaction);
    });
  }
};
</code>
</section>
</div>

</body>
</html>
