<!DOCTYPE html>
<!-- Generated by litjs - https://github.com/apres/lit.js
     Part of the Apres suite - http://apres.github.com/ -->
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <title>mysql-orm: initialise-schema.js</title>
  <link href='css/lit-callouts.css' rel='stylesheet' type='text/css'>
  <link href='css/apres.css' rel='stylesheet' type='text/css'>
</head>
<body>
  <div class="lit">
<section>
<div class="lit-comment">
<h1>mysql-orm: initialise-schema.js</h1>
</div>
<code class="lit-code">
<span class="string">'use strict'</span>;

<span class="comment">/*
 * MySQL object-relational mapping
 * ===============================
 *
 * (C) 2014 Mark K Cowan &lt;mark@battlesnake.co.uk>
 *
 * https://github.com/battlesnake/node-mysql-orm
 *
 * Released under GNU General Public License, Version 2
 *
 */</span>

<span class="keyword">var</span> mysql = require(<span class="string">'mysql'</span>);
<span class="keyword">var</span> async = require(<span class="string">'async'</span>);
<span class="keyword">var</span> _ = require(<span class="string">'underscore'</span>);

<span class="keyword">var</span> utils = require(<span class="string">'./utils'</span>);
<span class="keyword">var</span> names = utils.names;
<span class="keyword">var</span> indent = utils.indent;
</code>
</section>
<section>
<div class="lit-comment">
<h1>initialise-schema</h1>

<p>This module is used internally, you should never need to call it yourself.</p>

<h2>initialise_schema</h2>

<p>Initialises the schema:<br />+ Adds references to parent items.<br />+ Stores the name of each item into the item itself.<br />+ Creates primary key field <code>id</code> on tables with no <code>id</code> field and no<br />primary key.  Set <code>table.$primary = []</code> to disable creation of automatic<br />primary key field.<br />+ Expands shorthand string definitions to object definitions.</p>

<p>TODO: Define prototypes instead of assigning $type to each one</p>
</div>
<code class="lit-code">
module.exports.initialise_schema = initialise_schema;
<span class="function"><span class="keyword">function</span> <span class="title">initialise_schema</span><span class="params">(orm)</span> {</span>
  <span class="keyword">var</span> schema = orm.schema;
  schema.$name = orm.database;
  schema.$orm = orm;
  schema.$fullname = <span class="string">'('</span> + orm.database + <span class="string">')'</span>;
  schema.$type = <span class="string">'schema'</span>;
  names(schema).forEach(<span class="function"><span class="keyword">function</span> <span class="title">initialise_table</span><span class="params">(tableName)</span> {</span>
    orm.info(<span class="string">'schema '</span> + tableName);
    <span class="keyword">var</span> table = schema[tableName];
    table.$name = tableName;
    table.$schema = schema;
    table.$fullname = mysql.escapeId(tableName);
    table.$type = <span class="string">'table'</span>;
    <span class="keyword">if</span> (!_(table).has(<span class="string">'id'</span>) &amp;&amp; !_(table).has(<span class="string">'$primary'</span>)) {
      table.id = { type: <span class="string">'::id'</span> };
      table.$primary = <span class="string">'id'</span>;
    }
    <span class="keyword">if</span> (_(table.$primary).isString()) {
      table.$primary = [table.$primary];
    }
    table.$primary = table.$primary || [];
    names(table).forEach(<span class="function"><span class="keyword">function</span> <span class="title">initialise_field</span><span class="params">(fieldName)</span> {</span>
      orm.info(<span class="string">'schema '</span> + Array(tableName.length + <span class="number">1</span>).join(<span class="string">' '</span>) + <span class="string">'.'</span> +
        fieldName);
      <span class="keyword">var</span> fullname = mysql.escapeId(tableName) + <span class="string">'.'</span> +
        mysql.escapeId(fieldName);
      <span class="keyword">if</span> (_(table[fieldName]).isString()) {
        table[fieldName] = expand_field_shorthand_definition(orm,
          fullname, table[fieldName]);
      }
      <span class="keyword">var</span> field = table[fieldName];
      field.$name = fieldName;
      field.$table = table;
      field.$schema = schema;
      field.$fullname = fullname;
      field.$type = <span class="string">'field'</span>;
    });
  });
}
</code>
</section>
<section>
<div class="lit-comment">
<h2>expand_field_shorthand_definition</h2>

<p>Generates a field definition object from a shorthand string definition</p>

<p>Format: <code>'type[,unique][,index][,nullable][,cascade][,auto_increment]'</code></p>

<p>Order of items does not matter except <code>type</code>, which must be first.</p>
</div>
<code class="lit-code">
<span class="function"><span class="keyword">function</span> <span class="title">expand_field_shorthand_definition</span><span class="params">(orm, fullname, def)</span> {</span>
  <span class="keyword">var</span> err = <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span>
    <span class="keyword">return</span> <span class="string">'Failed to process field definition "'</span> + def + <span class="string">'" for field '</span> +
      fullname + <span class="string">': '</span> + msg;
  };
  <span class="keyword">var</span> f = def.split(<span class="string">','</span>).map(<span class="function"><span class="keyword">function</span> <span class="params">(s)</span> {</span> <span class="keyword">return</span> s.trim(); });
  <span class="function"><span class="keyword">function</span> <span class="title">flag</span><span class="params">(name)</span> {</span>
    <span class="keyword">var</span> idx = f.indexOf(name);
    <span class="keyword">if</span> (idx === -<span class="number">1</span>) {
      <span class="keyword">return</span> <span class="literal">false</span>;
    }
    <span class="keyword">else</span> {
      f.splice(idx, <span class="number">1</span>);
      <span class="keyword">return</span> <span class="literal">true</span>;
    }
  }
  <span class="keyword">if</span> (f.length === <span class="number">0</span>) {
    <span class="keyword">return</span> orm.error(err(<span class="string">'No type found'</span>));
  }
  field = {};
  field.type = f.shift();
  field.unique = flag(<span class="string">'unique'</span>);
  field.index = flag(<span class="string">'index'</span>);
  field.nullable = flag(<span class="string">'nullable'</span>);
  field.auto_increment = flag(<span class="string">'auto_increment'</span>);
  <span class="keyword">if</span> (flag(<span class="string">'cascade'</span>)) {
    field.onDelete = <span class="string">'cascade'</span>;
    field.onUpdate = <span class="string">'cascade'</span>;
  }
  f = _(f).compact();
  <span class="keyword">if</span> (f.length) {
    <span class="keyword">return</span> orm.error(err(<span class="string">'Residue: '</span> + f.join(<span class="string">','</span>)));
  }
  <span class="keyword">return</span> field;
}
</code>
</section>
</div>

</body>
</html>
