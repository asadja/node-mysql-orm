<!DOCTYPE html>
<!-- Generated by litjs - https://github.com/apres/lit.js
     Part of the Apres suite - http://apres.github.com/ -->
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <title>mysql-orm: autogen.js</title>
  <link href='css/lit-callouts.css' rel='stylesheet' type='text/css'>
  <link href='css/apres.css' rel='stylesheet' type='text/css'>
</head>
<body>
  <div class="lit">
<section>
<div class="lit-comment">
<h1>mysql-orm: autogen.js</h1>
</div>
<code class="lit-code">
<span class="string">'use strict'</span>;

<span class="comment">/*
 * MySQL object-relational mapping
 * ===============================
 *
 * (C) 2014 Mark K Cowan &lt;mark@battlesnake.co.uk>
 *
 * https://github.com/battlesnake/node-mysql-orm
 *
 * Released under GNU General Public License, Version 2
 *
 */</span>

<span class="keyword">var</span> mysql = require(<span class="string">'mysql'</span>);
<span class="keyword">var</span> async = require(<span class="string">'async'</span>);
<span class="keyword">var</span> _ = require(<span class="string">'underscore'</span>);

<span class="keyword">var</span> utils = require(<span class="string">'./utils'</span>);
<span class="keyword">var</span> names = utils.names;
<span class="keyword">var</span> indent = utils.indent;
</code>
</section>
<section>
<div class="lit-comment">
<h1>autogen</h1>

<p>This module is used internally, you should never need to call it yourself.</p>

<h2>create_database</h2>

<p>Creates the database if needed or if recreate is requested</p>
</div>
<code class="lit-code">
module.exports.create_database = create_database;
<span class="function"><span class="keyword">function</span> <span class="title">create_database</span><span class="params">(orm, recreate, callback)</span> {</span>
  <span class="keyword">var</span> queries = [];
  <span class="keyword">if</span> (recreate) {
    orm.warn(<span class="string">'Recreate is specified: dropping database '</span> + orm.database);
    queries.push(mysql.format(<span class="string">'DROP DATABASE IF EXISTS ??'</span>, [orm.database]));
  }
  queries.push(mysql.format(<span class="string">'CREATE DATABASE IF NOT EXISTS ??'</span>, [orm.database]));
  queries.push(mysql.format(<span class="string">'USE ??'</span>, [orm.database]));
  <span class="comment">/* Generate query executing functions from SQL commands */</span>
  queries = queries.map(<span class="function"><span class="keyword">function</span> <span class="params">(sql)</span> {</span>
    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">(callback)</span> {</span>
      orm.query(sql, <span class="literal">null</span>, callback);
    };
  });
  <span class="comment">/* Execute queries */</span>
  async.series(queries, callback);
};
</code>
</section>
<section>
<div class="lit-comment">
<h2>create_tables</h2>

<p>Creates the tables if needed or if recreate is requested</p>
</div>
<code class="lit-code">
module.exports.create_tables = create_tables;
<span class="function"><span class="keyword">function</span> <span class="title">create_tables</span><span class="params">(orm, recreate, callback)</span> {</span>
  <span class="keyword">var</span> queries = [];
  <span class="comment">/* Generate list of SQL commands */</span>
  queries.push(<span class="string">'SET FOREIGN_KEY_CHECKS = 0'</span>);
  <span class="keyword">if</span> (recreate) {
    <span class="keyword">var</span> tables = names(orm.schema);
    orm.warn(<span class="string">'Recreate is specified: dropping tables '</span> + tables.join(<span class="string">', '</span>));
    <span class="keyword">if</span> (tables.length) {
      queries.push(mysql.format(<span class="string">'DROP TABLE IF EXISTS ??'</span>, [tables]));
    }
  }
  names(orm.schema).forEach(<span class="function"><span class="keyword">function</span> <span class="params">(tableName)</span> {</span>
    queries.push(create_table(orm, orm.schema[tableName]));
  });
  queries.push(<span class="string">'SET FOREIGN_KEY_CHECKS = 1'</span>);
  <span class="comment">/* Execute queries */</span>
  async.series(
    queries.map(<span class="function"><span class="keyword">function</span> <span class="params">(sql)</span> {</span>
      <span class="keyword">return</span> async.apply(orm.query, sql, <span class="literal">null</span>);
    }),
    callback);
}
</code>
</section>
<section>
<div class="lit-comment">
<h2>create_table</h2>

<p>Generates a CREATE TABLE query for the given table definition</p>
</div>
<code class="lit-code">
<span class="function"><span class="keyword">function</span> <span class="title">create_table</span><span class="params">(orm, table)</span> {</span>
  <span class="keyword">var</span> columns = [];
  names(table).forEach(<span class="function"><span class="keyword">function</span> <span class="params">(fieldName)</span> {</span>
    columns.push(column_definition(orm, table[fieldName]));
  });
  <span class="keyword">if</span> (table.$primary &amp;&amp; table.$primary.length) {
    columns.push(mysql.format(<span class="string">'PRIMARY KEY (??)'</span>, [table.$primary]));
  }
  <span class="keyword">var</span> lines = [];
  lines.push(mysql.format(<span class="string">'CREATE TABLE IF NOT EXISTS ?? ('</span>, table.$name));
  lines.push(indent(columns.join(<span class="string">',\n'</span>)));
  lines.push(<span class="string">');'</span>);
  <span class="keyword">return</span> lines.join(<span class="string">'\n'</span>);
}
</code>
</section>
<section>
<div class="lit-comment">
<h2>column_definition</h2>

<p>Generates column_definition clauses for CREATE_TABLE</p>
</div>
<code class="lit-code">
<span class="function"><span class="keyword">function</span> <span class="title">column_definition</span><span class="params">(orm, field)</span> {</span>
  <span class="keyword">var</span> lines = [];
  <span class="keyword">if</span> (field.index) {
    lines.push([<span class="string">'INDEX ?? (??)'</span>, [field.index, field.$name]]);
  }
  <span class="keyword">if</span> (field.unique) {
    lines.push([<span class="string">'CONSTRAINT ?? UNIQUE KEY (??)'</span>, [field.unique, field.$name]]);
  }
  <span class="keyword">if</span> (field.references) {
    lines.push([[
      <span class="string">'CONSTRAINT ?? FOREIGN KEY (??)'</span>,
      <span class="string">'REFERENCES ?? (??)'</span>,
      <span class="string">'ON UPDATE '</span> + field.onUpdate,
      <span class="string">'ON DELETE '</span> + field.onDelete].join(<span class="string">'\n\t'</span>),
      [field.$fkname, field.$name, field.references.$table.$name,
      field.references.$name]]);
  }
  lines = lines
    .map(<span class="function"><span class="keyword">function</span> <span class="params">(ar)</span> {</span> <span class="keyword">return</span> mysql.format.apply(mysql, ar); })
    .map(indent);
  lines.unshift(_([
    mysql.escapeId(field.$name),
    field.type,
    field.auto_increment &amp;&amp; <span class="string">'AUTO_INCREMENT'</span>,
    !field.nullable &amp;&amp; <span class="string">'NOT NULL'</span>,
    field.<span class="keyword">default</span> &amp;&amp; (<span class="string">'DEFAULT '</span> + mysql.escape(field.<span class="keyword">default</span>))
  ]).compact().join(<span class="string">' '</span>));
  <span class="keyword">return</span> lines.join(<span class="string">',\n'</span>);
};
</code>
</section>
</div>

</body>
</html>
