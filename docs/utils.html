<!DOCTYPE html>
<!-- Generated by litjs - https://github.com/apres/lit.js
     Part of the Apres suite - http://apres.github.com/ -->
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <title>mysql-orm: utils.js</title>
  <link href='css/lit-callouts.css' rel='stylesheet' type='text/css'>
  <link href='css/apres.css' rel='stylesheet' type='text/css'>
</head>
<body>
  <div class="lit">
<section>
<div class="lit-comment">
<h1>mysql-orm: utils.js</h1>
</div>
<code class="lit-code">
<span class="string">'use strict'</span>;

<span class="comment">/*
 * MySQL object-relational mapping
 * ===============================
 *
 * (C) 2014 Mark K Cowan &lt;mark@battlesnake.co.uk>
 *
 * https://github.com/battlesnake/node-mysql-orm
 *
 * Released under GNU General Public License, Version 2
 *
 */</span>

<span class="keyword">var</span> mysql = require(<span class="string">'mysql'</span>);
<span class="keyword">var</span> async = require(<span class="string">'async'</span>);
<span class="keyword">var</span> _ = require(<span class="string">'underscore'</span>);
</code>
</section>
<section>
<div class="lit-comment">
<h1>util</h1>

<p>Internally-used utilities</p>

<h2>indent</h2>

<p>Indents a multiline string</p>
</div>
<code class="lit-code">
module.exports.indent = <span class="function"><span class="keyword">function</span> <span class="params">(str)</span> {</span>
  <span class="keyword">return</span> <span class="string">'\t'</span> + str.replace(<span class="regexp">/\n/g</span>, <span class="string">'\n\t'</span>);
};
</code>
</section>
<section>
<div class="lit-comment">
<h2>names</h2>

<p>Get a list of object names within the given object.  Returns all field names<br />that don't begin with <code>$</code>.</p>
</div>
<code class="lit-code">
module.exports.names = <span class="function"><span class="keyword">function</span> <span class="params">(obj)</span> {</span>
  <span class="keyword">return</span> _(obj).keys().filter(
    <span class="function"><span class="keyword">function</span> <span class="params">(key)</span> {</span>
      <span class="keyword">return</span> key.charAt(<span class="number">0</span>) !== <span class="string">'
</body>
</html>
</span>;
    });
};
</code>
</section>
<section>
<div class="lit-comment">
<h2>args</h2>

<p>Arguments parser for:</p>

<p>function ([query, ] table|field, [criteria, [options, ]] callback)</p>
</div>
<code class="lit-code">
module.exports.parse_args = <span class="function"><span class="keyword">function</span> <span class="params">(orm, args, wantsField)</span> {</span>
  args = [].slice.apply(args);
  <span class="keyword">var</span> params = {};
  params.query = (<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">return</span> (_(args[<span class="number">0</span>]).isFunction() &amp;&amp; args[<span class="number">0</span>].name === <span class="string">'query'</span>) ?
      args.shift() : orm.query;
  })();
  <span class="keyword">if</span> (wantsField) {
    params.field = (<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">return</span> args.shift();
    })();
  }
  <span class="keyword">else</span> {
    params.table = (<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">var</span> table = args.shift();
      <span class="keyword">if</span> (_(table).isString()) {
        <span class="keyword">return</span> orm.schema[table];
      }
      <span class="keyword">else</span> <span class="keyword">if</span> (_(table).isObject() &amp;&amp; table.$type === <span class="string">'table'</span>) {
        <span class="keyword">return</span> orm.schema[table.$name];
      }
      <span class="keyword">else</span> {
        <span class="keyword">return</span> table;
      }
    })();
  }
  params.callback = (<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">var</span> callback = args.pop();
    <span class="keyword">if</span> (!_(callback).isFunction()) {
      <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Callback is not a function!'</span>);
    }
    <span class="keyword">return</span> callback;
  })();
  params.data = (<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">var</span> data = args.shift();
    <span class="keyword">if</span> (_(data).isNull() || _(data).isUndefined()) {
      <span class="keyword">return</span> {};
    }
    <span class="keyword">if</span> (wantsField) {
      <span class="keyword">return</span> data;
    }
    <span class="keyword">if</span> (_(data).isString() || _(data).isNumber()) {
      <span class="keyword">if</span> (params.table.$primary.length !== <span class="number">1</span>) {
        <span class="keyword">return</span> callback(<span class="keyword">new</span> Error(<span class="string">'Table "'</span> + params.table.$name +
          <span class="string">'" has no simple primary key, please specify a search '</span> +
          <span class="string">'key explicitly'</span>));
      }
      <span class="keyword">return</span> _.object([params.table.$primary[<span class="number">0</span>]], [data]);
    }
    <span class="keyword">return</span> data;
  })();
  <span class="keyword">var</span> hasOptions;
  params.options = (<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">var</span> options = args.shift();
    hasOptions = !!options &amp;&amp; options != {};
    <span class="keyword">return</span> options || {};
  })();
  params.hasOptions = hasOptions;
  <span class="keyword">return</span> params;
};
</code>
</section>
</div>

</body>
</html>
