<!DOCTYPE html>
<!-- Generated by litjs - https://github.com/apres/lit.js
     Part of the Apres suite - http://apres.github.com/ -->
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <title>mysql-orm: logging-query.js</title>
  <link href='css/lit-callouts.css' rel='stylesheet' type='text/css'>
  <link href='css/apres.css' rel='stylesheet' type='text/css'>
</head>
<body>
  <div class="lit">
<section>
<div class="lit-comment">
<h1>mysql-orm: logging-query.js</h1>
</div>
<code class="lit-code">
<span class="string">'use strict'</span>;
<span class="comment">/*
 * MySQL object-relational mapping
 * ===============================
 *
 * (C) 2014 Mark K Cowan &lt;mark@battlesnake.co.uk>
 *
 * https://github.com/battlesnake/node-mysql-orm
 *
 * Released under GNU General Public License, Version 2
 *
 */</span>

<span class="keyword">var</span> mysql = require(<span class="string">'mysql'</span>);
<span class="keyword">var</span> cli = require(<span class="string">'cli-color'</span>);
<span class="keyword">var</span> _ = require(<span class="string">'underscore'</span>);

<span class="keyword">var</span> utils = require(<span class="string">'./utils'</span>);
<span class="keyword">var</span> indent = utils.indent;

<span class="keyword">var</span> ORM = { prototype: {} };
module.exports = ORM.prototype;
</code>
</section>
<section>
<div class="lit-comment">
<h1>logging-query</h1>

<p>Makes query diagnostics really easy</p>

<h2>loggedQuery(connection)</h2>

<p>Query logging</p>

<p>Creates a wrapper around a pool/connection query function</p>

<p>query is function with same signatures as mysql's connection.query</p>

<p>Each call to loggedQuery generated a logging function with a different cid<br />value.  Each call to the returned query function increases the qid value<br />associated with that cid.</p>

<h3>Example</h3>

<p>query = loggedQuery(connection)</p>
</div>
<code class="lit-code">
<span class="keyword">var</span> cid_static = <span class="number">0</span>;
ORM.prototype.loggedQuery = <span class="function"><span class="keyword">function</span> <span class="params">(connection)</span> {</span>
  <span class="keyword">var</span> qid_static = <span class="number">0</span>;
  <span class="keyword">var</span> cid = String(cid_static++);
  <span class="keyword">var</span> self = <span class="keyword">this</span>;
  <span class="function"><span class="keyword">function</span> <span class="title">query</span><span class="params">(query_format, params, callback)</span> {</span>
    <span class="keyword">var</span> qid = String(qid_static++);
    <span class="keyword">var</span> qidstr = cli.magenta(<span class="string">'cid:'</span> + cid + <span class="string">', qid:'</span> + qid) + Array((cid + qid).length &lt; <span class="number">6</span> ? <span class="number">6</span> - (cid + qid).length : <span class="number">1</span>).join(<span class="string">' '</span>);
    <span class="keyword">var</span> log = <span class="function"><span class="keyword">function</span> <span class="params">(left, value)</span> {</span>
      self.info(qidstr + left + (value.indexOf(<span class="string">'\n'</span>) === -<span class="number">1</span> ? value : <span class="string">'\n'</span> + indent(value).replace(<span class="regexp">/\t/g</span>, <span class="string">'    '</span>)));
    };
    <span class="keyword">if</span> (!_(query_format).isString() || params) {
      log(<span class="string">'query  = '</span>, (_(query_format).isString() ? query_format : JSON.stringify(query_format)));
      log(<span class="string">'params = '</span>, JSON.stringify(params));
      log(<span class="string">'sql    = '</span>, mysql.format(query_format, params));
    }
    <span class="keyword">else</span> {
      log(<span class="string">'sql = '</span>, mysql.format(query_format, params));
    }
    connection.query(query_format, params, <span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
      <span class="keyword">if</span> (err) {
        self[self.ready ? <span class="string">'warn'</span> : <span class="string">'error'</span>](qidstr + <span class="string">'error = '</span> + JSON.stringify(err));
      }
      callback.apply(<span class="literal">null</span>, arguments);
    });
  };
  query._cid = cid;
  query._msg = <span class="function"><span class="keyword">function</span> <span class="params">(str)</span> {</span>
    <span class="keyword">return</span> cli.magenta(<span class="string">'cid:'</span> + cid + <span class="string">'     '</span>) + Array(cid.length &lt; <span class="number">6</span> ? <span class="number">6</span> - cid.length : <span class="number">1</span>).join(<span class="string">' '</span>) + <span class="string">' '</span> + str;
  };
  <span class="keyword">return</span> query;
};
</code>
</section>
</div>

</body>
</html>
